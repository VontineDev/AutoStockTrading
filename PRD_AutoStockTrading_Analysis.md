### **PRD: 자동 주식 거래 및 분석 프레임워크 (AutoStockTrading)**

**1. 개요 (Overview)**

본 프로젝트는 한국 주식 시장(코스피, 코스닥)을 대상으로 하는 **고성능 트레이딩 전략 분석 및 자동매매 프레임워크**입니다. 사용자는 명령줄 인터페이스(CLI)와 웹 대시보드(Streamlit)를 통해 데이터 수집, 기술적 분석, 전략 백테스팅, 결과 분석에 이르는 전 과정을 수행할 수 있습니다. 특히, 수백 개 이상의 종목에 대한 대규모 백테스팅을 효율적으로 처리하기 위해 **캐싱, 병렬 처리, 배치 최적화** 등 다단계 성능 최적화 아키텍처를 채택한 것이 핵심입니다.

**2. 목표 (Goals)**

*   **고속 백테스팅:** 수백 개 이상의 종목과 여러 전략 조합에 대한 백테스팅을 수 분 내에 완료할 수 있는 고성능 환경 제공.
*   **전략 개발 및 검증:** `TA-Lib` 기반의 다양한 기술적 분석 지표를 활용하여 자신만의 매매 전략을 쉽게 구현하고, 과거 데이터를 통해 객관적으로 성과를 검증.
*   **데이터 중심 의사결정:** 백테스팅 결과를 다각도로 분석(수익률, 승률, 샤프 지수 등)하고, 리포트를 자동 생성하여 데이터에 기반한 투자 전략 수립 지원.
*   **사용자 편의성:** 직관적인 CLI와 시각적인 웹 대시보드를 통해 복잡한 분석 과정을 쉽게 실행하고 모니터링.
*   **모듈화 및 확장성:** 데이터, 전략, API, UI 등 기능별로 명확히 분리된 모듈식 설계를 통해 새로운 기능 및 전략의 추가/변경이 용이하도록 구축.

**3. 핵심 기능 및 동작 원리 (Core Features & How It Works)**

#### **3.1. 시스템 코어 및 CLI (`src/cli.py`, `src/commands/`)**

*   **동작 원리:**
    *   `cli.py`는 시스템의 **메인 컨트롤 타워** 역할을 합니다. `argparse`를 사용해 `update-data`, `backtest`, `analyze-results`, `web` 등 다양한 명령어를 정의합니다.
    *   사용자가 `python src/cli.py backtest --all-kospi --parallel`과 같은 명령을 실행하면, `cli.py`는 해당 인자를 파싱하여 `src/commands/backtester_cmd.py`의 `run_backtest` 함수를 호출합니다.
    *   각 `_cmd.py` 파일은 특정 명령어에 대한 실제 로직을 수행하는 **실행기**입니다.
    *   `config_loader.py`는 `config.yaml`의 설정값과 `.env`의 API 키 같은 민감 정보를 중앙에서 관리하여 시스템 전반에 일관된 설정을 제공합니다.
    *   `constants.py`는 코드 내 매직 넘버(e.g., RSI 기간 `14`, 초기 자본금 `1,000,000`)를 상수로 정의하여 유지보수성을 높입니다.

#### **3.2. 데이터 파이프라인 (`src/data/`)**

*   **동작 원리:**
    1.  **데이터 수집 (`updater.py`):** `StockDataUpdater` 클래스가 `pykrx` 라이브러리를 통해 KOSPI, KOSDAQ의 OHLCV(시가/고가/저가/종가/거래량) 데이터를 수집합니다. 또한 `krx_sector_*.csv` 파일을 읽어 종목의 섹터 정보를 통합합니다.
    2.  **데이터베이스 저장 (`database.py`):** 수집된 데이터는 `trading.db`라는 SQLite 데이터베이스에 저장됩니다. `stock_info` 테이블에는 종목 정보가, `stock_data` 테이블에는 일별 시세 데이터가 저장됩니다.
    3.  **데이터 관리 (`stock_data_manager.py`):** `StockDataManager`는 데이터베이스와의 상호작용을 추상화하여, 특정 기간의 종목 데이터를 쉽게 조회할 수 있는 인터페이스를 제공합니다.
    4.  **기술적 지표 계산 (`indicators.py`):** `TALibIndicators` 클래스가 `TA-Lib`을 사용하여 로드된 데이터에 RSI, MACD, 볼린저 밴드 등 핵심 보조지표를 계산하여 추가합니다. 이 계산된 데이터프레임이 전략 분석의 기반이 됩니다.

#### **3.3. 매매 전략 프레임워크 (`src/strategies/`)**

*   **동작 원리:**
    *   `base_strategy.py`는 모든 전략의 **설계도** 역할을 하는 추상 클래스(`BaseStrategy`)를 정의합니다. 모든 전략은 이 클래스를 상속받아 `calculate_indicators`와 `generate_signals` 메서드를 자신만의 로직으로 구현해야 합니다.
    *   `macd_strategy.py`, `rsi_strategy.py` 등은 `BaseStrategy`를 상속받은 **구체적인 전략 클래스**입니다. 예를 들어, `MACDStrategy`는 MACD 골든크로스에서 매수 신호를, 데드크로스에서 매도 신호를 생성하는 로직을 포함합니다.
    *   이 구조 덕분에 새로운 전략(예: 스토캐스틱 전략)을 추가하고 싶을 때, `base_strategy.py`의 규칙에 맞춰 새 파일만 추가하면 시스템에 쉽게 통합됩니다.

#### **3.4. 3단계 백테스팅 엔진 (`src/trading/`)**

이 프로젝트의 가장 큰 특징으로, 백테스팅할 종목 수에 따라 **최적의 엔진을 자동으로 선택**하여 성능과 안정성의 균형을 맞춥니다.

*   **1단계: 순차 엔진 (`backtest.py`)**
    *   **대상:** 1~9개 소수 종목
    *   **동작:** `BacktestEngine`이 단일 스레드에서 종목 데이터를 순차적으로 처리. 각 날짜를 반복하며 신호를 확인하고, 포트폴리오 상태(현금, 포지션)를 업데이트하며 거래를 시뮬레이션. 디버깅 및 상세 로그 확인에 최적화.

*   **2단계: 병렬 처리 엔진 (`parallel_backtest.py`)**
    *   **대상:** 10~99개 중규모 종목
    *   **동작:** `ParallelBacktestEngine`이 `ProcessPoolExecutor`를 사용해 여러 CPU 코어에 작업을 분산. 종목 리스트를 작은 `청크(chunk)` 단위로 나누어 각 코어가 동시에 백테스팅을 수행. 순차 처리 대비 **수 배에서 수십 배 빠른 속도**를 제공.

*   **3단계: 완전 최적화 엔진 (`optimized_backtest.py`)**
    *   **대상:** 100개 이상 대규모 종목
    *   **동작:** `OptimizedBacktestEngine`은 **궁극의 성능**을 위해 아래 3가지 기술을 통합합니다.
        1.  **캐싱 (`cache_manager.py`):** 동일한 종목, 전략, 기간으로 이미 수행된 백테스트 결과를 `backtest_cache.db`에 저장. 재실행 요청 시, 계산 없이 즉시 캐시된 결과를 반환하여 **반복 테스트 시간을 획기적으로 단축**.
        2.  **배치 처리 (`batch_optimizer.py`):** 수백 개의 종목 데이터를 한 번에 메모리에 올릴 때 발생하는 문제를 막기 위해, 전체 작업을 **메모리 상황에 맞춰 동적으로 조절되는 배치(batch) 단위**로 나누어 처리. 시스템 안정성 확보.
        3.  **병렬 처리:** 위에서 설명한 병렬 처리 엔진을 그대로 활용.

#### **3.5. 분석 및 시각화 (`analyzer_cmd.py`, `streamlit_app/app.py`)**

*   **동작 원리:**
    *   백테스팅이 완료되면 결과는 `backtest_results` 폴더에 JSON 파일로 저장됩니다.
    *   `analyze-results` 명령어는 이 JSON 파일을 읽어 `analyzer_cmd.py`를 통해 전체 수익률, 승률, 샤프 지수 등을 계산하고, 우수 전략/종목을 선별하여 `.csv` 및 `.md` 형태의 **상세 분석 리포트를 생성**합니다.
    *   `web` 명령어는 `streamlit_app/app.py`를 실행하여 **웹 기반 대시보드**를 제공합니다. 사용자는 이 대시보드에서 특정 종목의 차트와 보조지표를 시각적으로 확인하고, 간단한 백테스팅을 직접 실행하며 결과를 즉시 확인할 수 있습니다.

#### **3.6. API 연동 (`src/api/`)**

*   **동작 원리:**
    *   `kiwoom_client.py`와 `auth.py`를 통해 키움증권 API에 연결하여 토큰을 발급받고, 계좌 정보나 실시간 시세를 조회할 수 있는 기반을 마련했습니다.
    *   현재는 백테스팅과 직접적으로 연동되어 있지는 않지만, 향후 **실시간 자동매매 기능을 구현하기 위한 확장 포인트**로 사용될 수 있습니다.

**4. 데이터 및 시스템 흐름도 (Data & System Flow)**

1.  **설정 (`config.yaml`, `.env`):** 사용자가 API 키, 매매 전략, 종목, 기간 등 주요 파라미터 설정.
2.  **CLI 명령어 실행:** `python src/cli.py update-data` 또는 `python src/cli.py backtest` 실행.
3.  **데이터 수집/업데이트:** `updater.py`가 `pykrx`를 통해 데이터를 수집하여 `trading.db`에 저장.
4.  **백테스팅 실행:**
    *   `backtester_cmd.py`가 종목 수를 판단하여 최적의 엔진(순차/병렬/최적화) 선택.
    *   엔진이 `stock_data_manager.py`를 통해 DB에서 데이터를 로드.
    *   `indicators.py`가 보조지표를 계산.
    *   선택된 `strategy`가 매매 신호를 생성.
    *   `backtest.py`의 포트폴리오 관리 로직에 따라 모의 거래 실행.
5.  **결과 저장 및 분석:**
    *   백테스팅 결과가 `backtest_results/` 폴더에 JSON으로 저장됨.
    *   `analyzer_cmd.py`가 이 파일을 분석하여 상세 리포트 생성.
6.  **시각화 (UI):**
    *   `streamlit_app/app.py`가 `trading.db`의 데이터와 백테스팅 결과를 읽어와 대시보드에 차트와 표로 시각화.
